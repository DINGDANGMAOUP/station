version: '3.8'

services:
  # Redis Cluster Node 1
  redis-cluster-1:
    image: redis:7-alpine
    container_name: redis-cluster-1
    hostname: redis-cluster-1
    command: >
      redis-server
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --cluster-announce-hostname redis-cluster-1
      --appendonly yes
      --requirepass redis123
      --masterauth redis123
      --port 6379
    ports:
      - "6379:6379"
      - "16379:16379"
    volumes:
      - redis-cluster-1-data:/data
    networks:
      - station-network

  # Redis Cluster Node 2
  redis-cluster-2:
    image: redis:7-alpine
    container_name: redis-cluster-2
    hostname: redis-cluster-2
    command: >
      redis-server
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --cluster-announce-hostname redis-cluster-2
      --appendonly yes
      --requirepass redis123
      --masterauth redis123
      --port 6379
    ports:
      - "6380:6379"
      - "16380:16379"
    volumes:
      - redis-cluster-2-data:/data
    networks:
      - station-network

  # Redis Cluster Node 3
  redis-cluster-3:
    image: redis:7-alpine
    container_name: redis-cluster-3
    hostname: redis-cluster-3
    command: >
      redis-server
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --cluster-announce-hostname redis-cluster-3
      --appendonly yes
      --requirepass redis123
      --masterauth redis123
      --port 6379
    ports:
      - "6381:6379"
      - "16381:16379"
    volumes:
      - redis-cluster-3-data:/data
    networks:
      - station-network

  # Redis Cluster Node 4
  redis-cluster-4:
    image: redis:7-alpine
    container_name: redis-cluster-4
    hostname: redis-cluster-4
    command: >
      redis-server
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --cluster-announce-hostname redis-cluster-4
      --appendonly yes
      --requirepass redis123
      --masterauth redis123
      --port 6379
    ports:
      - "6382:6379"
      - "16382:16379"
    volumes:
      - redis-cluster-4-data:/data
    networks:
      - station-network

  # Redis Cluster Node 5
  redis-cluster-5:
    image: redis:7-alpine
    container_name: redis-cluster-5
    hostname: redis-cluster-5
    command: >
      redis-server
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --cluster-announce-hostname redis-cluster-5
      --appendonly yes
      --requirepass redis123
      --masterauth redis123
      --port 6379
    ports:
      - "6383:6379"
      - "16383:16379"
    volumes:
      - redis-cluster-5-data:/data
    networks:
      - station-network

  # Redis Cluster Node 6
  redis-cluster-6:
    image: redis:7-alpine
    container_name: redis-cluster-6
    hostname: redis-cluster-6
    command: >
      redis-server
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --cluster-announce-hostname redis-cluster-6
      --appendonly yes
      --requirepass redis123
      --masterauth redis123
      --port 6379
    ports:
      - "6384:6379"
      - "16384:16379"
    volumes:
      - redis-cluster-6-data:/data
    networks:
      - station-network

  # Cluster initialization container
  redis-cluster-init:
    image: redis:7-alpine
    container_name: redis-cluster-init
    command:
      - sh
      - -c
      - |
        sleep 15
        redis-cli -a redis123 --cluster create \
          redis-cluster-1:6379 \
          redis-cluster-2:6379 \
          redis-cluster-3:6379 \
          redis-cluster-4:6379 \
          redis-cluster-5:6379 \
          redis-cluster-6:6379 \
          --cluster-replicas 1 \
          --cluster-yes
        echo "Redis Cluster initialized successfully"

        # Verify cluster is using hostnames
        echo "Verifying cluster nodes..."
        redis-cli -c -a redis123 -h redis-cluster-1 CLUSTER NODES

        sleep infinity
    networks:
      - station-network
    depends_on:
      - redis-cluster-1
      - redis-cluster-2
      - redis-cluster-3
      - redis-cluster-4
      - redis-cluster-5
      - redis-cluster-6

  # Station node 1
  station-1:
    image: ghcr.io/dingdangmaoup/station:latest
    container_name: station-node-1
    hostname: station-node-1
    environment:
      # Node Configuration
      - HOSTNAME=station-node-1
      - STATION_GRPC_PORT=50051
      - STATION_HTTP_PORT=5000

      # Redis Configuration
      - STATION_REDIS_MODE=cluster
      - STATION_REDIS_PASSWORD=redis123
      - STATION_REDIS_CLUSTER_NODES=redis-cluster-1:6379,redis-cluster-2:6379,redis-cluster-3:6379,redis-cluster-4:6379,redis-cluster-5:6379,redis-cluster-6:6379
      - STATION_REDIS_CLUSTER_MAX_REDIRECTS=3
      - STATION_REDIS_DATABASE=0
      - STATION_REDIS_TIMEOUT=5s

      # Discovery Configuration
      - STATION_DISCOVERY_TYPE=redis
      - STATION_DISCOVERY_HEARTBEAT_INTERVAL=10s
      - STATION_DISCOVERY_REFRESH_INTERVAL=5s
      - STATION_DISCOVERY_REDIS_MAX_ATTEMPTS=6
      - STATION_DISCOVERY_REDIS_INITIAL_BACKOFF=5s
      - STATION_DISCOVERY_REDIS_MAX_BACKOFF=10s
      - STATION_DISCOVERY_REDIS_NODE_TIMEOUT=30s

      # Storage Configuration
      - STATION_STORAGE_PATH=/data/station
      - STATION_STORAGE_BLOB_CHUNK_SIZE=65536

      # Cache Configuration
      - STATION_CACHE_LOCAL_MAX_SIZE=1GB
      - STATION_CACHE_LOCAL_MAX_ENTRIES=10000
      - STATION_CACHE_LOCAL_TTL=1h
      - STATION_CACHE_REDIS_MANIFEST_TTL=24h
      - STATION_CACHE_REDIS_BLOB_TTL=168h

      # Coordination Configuration
      - STATION_COORDINATION_VIRTUAL_NODES=150
      - STATION_COORDINATION_LOCK_TTL=30s
      - STATION_COORDINATION_LOCK_WAIT_TIMEOUT=10s

      # Eviction Configuration
      - STATION_EVICTION_ENABLED=true
      - STATION_EVICTION_CHECK_INTERVAL=1h
      - STATION_EVICTION_THRESHOLD=90

      # Logging Configuration
      - STATION_REQUEST_LOGGING=false
      - STATION_INCLUDE_HEADERS=false

      # JVM Options
      - JAVA_OPTS=-Xms1g -Xmx1g
    ports:
      - "5001:5000"
      - "50051:50051"
    volumes:
      - station-1-data:/data/station
    networks:
      - station-network
    depends_on:
      - redis-cluster-init
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/actuator/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 60s

  # Station node 2
  station-2:
    image: ghcr.io/dingdangmaoup/station:latest
    container_name: station-node-2
    hostname: station-node-2
    environment:
      # Node Configuration
      - HOSTNAME=station-node-2
      - STATION_GRPC_PORT=50051
      - STATION_HTTP_PORT=5000

      # Redis Configuration
      - STATION_REDIS_MODE=cluster
      - STATION_REDIS_PASSWORD=redis123
      - STATION_REDIS_CLUSTER_NODES=redis-cluster-1:6379,redis-cluster-2:6379,redis-cluster-3:6379,redis-cluster-4:6379,redis-cluster-5:6379,redis-cluster-6:6379
      - STATION_REDIS_CLUSTER_MAX_REDIRECTS=3
      - STATION_REDIS_DATABASE=0
      - STATION_REDIS_TIMEOUT=5s

      # Discovery Configuration
      - STATION_DISCOVERY_TYPE=redis
      - STATION_DISCOVERY_HEARTBEAT_INTERVAL=10s
      - STATION_DISCOVERY_REFRESH_INTERVAL=5s
      - STATION_DISCOVERY_REDIS_MAX_ATTEMPTS=6
      - STATION_DISCOVERY_REDIS_INITIAL_BACKOFF=5s
      - STATION_DISCOVERY_REDIS_MAX_BACKOFF=10s
      - STATION_DISCOVERY_REDIS_NODE_TIMEOUT=30s

      # Storage Configuration
      - STATION_STORAGE_PATH=/data/station
      - STATION_STORAGE_BLOB_CHUNK_SIZE=65536

      # Cache Configuration
      - STATION_CACHE_LOCAL_MAX_SIZE=1GB
      - STATION_CACHE_LOCAL_MAX_ENTRIES=10000
      - STATION_CACHE_LOCAL_TTL=1h
      - STATION_CACHE_REDIS_MANIFEST_TTL=24h
      - STATION_CACHE_REDIS_BLOB_TTL=168h

      # Coordination Configuration
      - STATION_COORDINATION_VIRTUAL_NODES=150
      - STATION_COORDINATION_LOCK_TTL=30s
      - STATION_COORDINATION_LOCK_WAIT_TIMEOUT=10s

      # Eviction Configuration
      - STATION_EVICTION_ENABLED=true
      - STATION_EVICTION_CHECK_INTERVAL=1h
      - STATION_EVICTION_THRESHOLD=90

      # Logging Configuration
      - STATION_REQUEST_LOGGING=false
      - STATION_INCLUDE_HEADERS=false

      # JVM Options
      - JAVA_OPTS=-Xms1g -Xmx1g
    ports:
      - "5002:5000"
      - "50052:50051"
    volumes:
      - station-2-data:/data/station
    networks:
      - station-network
    depends_on:
      - redis-cluster-init
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/actuator/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 60s

  # Station node 3
  station-3:
    image: ghcr.io/dingdangmaoup/station:latest
    container_name: station-node-3
    hostname: station-node-3
    environment:
      # Node Configuration
      - HOSTNAME=station-node-3
      - STATION_GRPC_PORT=50051
      - STATION_HTTP_PORT=5000

      # Redis Configuration
      - STATION_REDIS_MODE=cluster
      - STATION_REDIS_PASSWORD=redis123
      - STATION_REDIS_CLUSTER_NODES=redis-cluster-1:6379,redis-cluster-2:6379,redis-cluster-3:6379,redis-cluster-4:6379,redis-cluster-5:6379,redis-cluster-6:6379
      - STATION_REDIS_CLUSTER_MAX_REDIRECTS=3
      - STATION_REDIS_DATABASE=0
      - STATION_REDIS_TIMEOUT=5s

      # Discovery Configuration
      - STATION_DISCOVERY_TYPE=redis
      - STATION_DISCOVERY_HEARTBEAT_INTERVAL=10s
      - STATION_DISCOVERY_REFRESH_INTERVAL=5s
      - STATION_DISCOVERY_REDIS_MAX_ATTEMPTS=6
      - STATION_DISCOVERY_REDIS_INITIAL_BACKOFF=5s
      - STATION_DISCOVERY_REDIS_MAX_BACKOFF=10s
      - STATION_DISCOVERY_REDIS_NODE_TIMEOUT=30s

      # Storage Configuration
      - STATION_STORAGE_PATH=/data/station
      - STATION_STORAGE_BLOB_CHUNK_SIZE=65536

      # Cache Configuration
      - STATION_CACHE_LOCAL_MAX_SIZE=1GB
      - STATION_CACHE_LOCAL_MAX_ENTRIES=10000
      - STATION_CACHE_LOCAL_TTL=1h
      - STATION_CACHE_REDIS_MANIFEST_TTL=24h
      - STATION_CACHE_REDIS_BLOB_TTL=168h

      # Coordination Configuration
      - STATION_COORDINATION_VIRTUAL_NODES=150
      - STATION_COORDINATION_LOCK_TTL=30s
      - STATION_COORDINATION_LOCK_WAIT_TIMEOUT=10s

      # Eviction Configuration
      - STATION_EVICTION_ENABLED=true
      - STATION_EVICTION_CHECK_INTERVAL=1h
      - STATION_EVICTION_THRESHOLD=90

      # Logging Configuration
      - STATION_REQUEST_LOGGING=false
      - STATION_INCLUDE_HEADERS=false

      # JVM Options
      - JAVA_OPTS=-Xms1g -Xmx1g
    ports:
      - "5003:5000"
      - "50053:50051"
    volumes:
      - station-3-data:/data/station
    networks:
      - station-network
    depends_on:
      - redis-cluster-init
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/actuator/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 60s

  # Nginx load balancer
  nginx:
    image: nginx:alpine
    container_name: station-nginx
    ports:
      - "9000:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - station-network
    depends_on:
      - station-1
      - station-2
      - station-3

volumes:
  redis-cluster-1-data:
  redis-cluster-2-data:
  redis-cluster-3-data:
  redis-cluster-4-data:
  redis-cluster-5-data:
  redis-cluster-6-data:
  station-1-data:
  station-2-data:
  station-3-data:

networks:
  station-network:
    driver: bridge
